# ハンズオンの内容

AWS SDK JSを使ってブラウザから簡単にS3へファイルアップロードする.
多分ハンズオンだけなら30～45分位で終わるとおもう。

# つかうサービス

- S3
- Cognito
- IAM

# S3のバケット作成、CognitoのIDプール作成はAWSコンソールからやる

AWSマネージメントコンソールで画面右上のリージョンが **東京** であることを確認。

# S3のバケット
1. AWSマネージメントコンソールの **AWSのサービス** のところで「s3」と入力して表示されるリストの1番目を選択する
   ![](/img/1st-01.png)
2. S3バケット画面で **バケットを作成する** ボタンをクリック
   ![](/img/1st-02.png)
   * バケット名は **jaws09-20190706-<姓>** にする(例: jaws09-20190706-tamura)
   * リージョンが **アジアパシフィック(東京)** なのを確認
   ![](/img/1st-03.png)
3. オプションの設定、アクセス許可の設定は変更なし
   ![](/img/1st-04.png)
   ![](/img/1st-05.png)
4. 確認画面はバケット名とリージョンを再確認し、バケット名はコピペしておく
   ![](/img/1st-06.png)
5. 作成したバケットを開く
   ![](/img/1st-16.png)
6. 「アクセス権限」のタブを開き「CORSの設定」をクリックする
   ![](/img/1st-17.png)
7. 「CORS構成エディター」に以下の内容をコピペして保存する
```
<?xml version="1.0" encoding="UTF-8"?>
<CORSConfiguration xmlns="http://s3.amazonaws.com/doc/2006-03-01/">
    <CORSRule>
        <AllowedOrigin>*</AllowedOrigin>
        <AllowedMethod>PUT</AllowedMethod>
        <AllowedHeader>*</AllowedHeader>
    </CORSRule>
</CORSConfiguration>
```



# CognitoのIDプール
1. AWSマネージメントコンソールの **AWSのサービス** のところで「cognito」と入力して表示されるリストの1番目を選択する
2. **IDプールの管理** ボタンをクリック
   ![](/img/1st-07.png)
3. 新しいIDプールの作成で、IDプール名は **jaws09_20190706_<姓>** にする(例: jaws09_20190706_tamura)
   ![](/img/1st-08.png)
   * S3と違ってハイフンが使えないのでアンダーバー
   * **認証されていないIDに対してアクセスを有効にする** チェックボックスをチェック
4. **プールの作成** ボタンをクリック
5. **Your Cognito identities require access to your resousces** の画面では **詳細を非表示** のところをクリックしてアコーディオンを開いて確認
   ![](/img/1st-09.png)
6. **IAMロール** がいずれも **新しいIAMロールの作成** になっていることを確認
7. **ロール名** は特に変更しない
8. **許可** ボタンをクリック
9. **Amazon Cognito での作業開始** 画面が開いたら **プラットフォーム** のプルダウンで **JavaScript** を選択
10. 表示される **AWS認証情報の取得** 欄をまるごとコピペしておく
   ![](/img/1st-10.png)


# IAMでCognitoのRoleへのポリシー設定
1. AWSマネージメントコンソールの **AWSのサービス** のところで「iam」と入力して表示されるリストの1番目を選択する
2. 画面左側のメニューから **ロール** を選択する
   ![](/img/1st-11.png)
3. ロール一覧から **Cognito_jaws09_20190706** から始まるものが2つあるはずなので、そのうちの2つ目を選択
   ![](/img/1st-12.png)
4. **ロールARN** のところが **Unauth_Role** で終わっているのを確認する
   ![](/img/1st-13.png)
   * **Auth_Role** になっていたら違うので、もう一度選択し直す
6. **ポリシーをアタッチします** ボタンをクリック
7. **ポリシーのフィルタ** に「s3」と入力して絞り込まれたリストから **AmazonS3FullAccess** の左側のチェックボックスをチェック
   ![](/img/1st-14.png)
8. **ポリシーのアタッチ** ボタンをクリック


# S3へのアップロードのhtml, js
see: [upload.html](/upload.html)

* `<IDプールID>` をCongnitoの **AWS認証情報欄の取得** でコピペした中の `IdentityPoolId` の値(`ap-northeast-1` から始まるもの) に置き換える.
* `<S3バケット名>` をS3で作成したバケット名に置き換える.
* upload.html をブラウザで開いてファイルを選択したあと「アップロード」ボタンを押すとS3にアップロードされる.

# S3へアップロードしたものの確認もAWSコンソールからS3をひらいて確認する

![](/img/1st-15.png)
